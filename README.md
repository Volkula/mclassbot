# Бот регистрации на события в Telegram

Система для регистрации на события и мастер‑классы через Telegram:

- **Пользователь** просматривает события и регистрируется **прямо в боте**.
- **Администратор** и **помощники** управляют событиями, регистрациями, уведомлениями и экспортом данных.
- Уведомления о событиях отправляются автоматически по расписанию с учётом **часового пояса (GMT+3 по умолчанию)**.

---

## Быстрый старт

### 1. Клонирование и установка зависимостей

```bash
git clone <URL_ВАШЕГО_РЕПОЗИТОРИЯ>.git
cd viraj_app

python3 -m venv venv
source venv/bin/activate  # Linux/macOS
# или
venv\Scripts\activate     # Windows

pip install -r requirements.txt
```

### 2. Настройка окружения

1. Создайте файл `.env` на основе шаблона:

```bash
cp .env.example .env
```

2. Откройте `.env` и заполните значения:
   - `BOT_TOKEN` — токен бота из [`@BotFather`](https://t.me/BotFather)
   - `DATABASE_URL` — строка подключения к БД (по умолчанию SQLite файл)
   - `ADMIN_USER_IDS` — Telegram ID админов через запятую
   - `TIMEZONE` — часовой пояс, по умолчанию `Europe/Moscow` (GMT+3)

### 3. Миграции БД

```bash
alembic upgrade head
```

По умолчанию используется SQLite файл `event_registration.db` в корне проекта.  
Вы можете указать любую СУБД, поддерживаемую SQLAlchemy, через `DATABASE_URL`.

---

## Запуск

### Вариант 1: запуск через скрипт

```bash
chmod +x run.sh
./run.sh
```

Скрипт:
- активирует `venv` (если есть),
- запускает Telegram‑бота,
- запускает API (`FastAPI`) для будущего мини‑приложения.

### Вариант 2: ручной запуск

Запуск бота:

```bash
python -m bot.main
```

Запуск API:

```bash
uvicorn api.main:app --host 0.0.0.0 --port 8000
```

Планировщик уведомлений (`APScheduler`) поднимается автоматически внутри бота.

---

## Переменные окружения

Все настройки читаются из `.env` через `config.py` (`pydantic-settings`):

- **BOT_TOKEN** — токен Telegram‑бота.
- **WEBAPP_URL** — (опционально) базовый URL мини‑приложения, если потребуется.
- **DATABASE_URL** — строка подключения к БД  
  Примеры:
  - `sqlite:///./event_registration.db`
  - `postgresql+psycopg2://user:password@localhost:5432/viraj`
- **API_HOST** — хост FastAPI (по умолчанию `0.0.0.0`).
- **API_PORT** — порт FastAPI (по умолчанию `8000`).
- **ADMIN_USER_IDS** — список Telegram ID админов, например `123456789,987654321`.
- **TIMEZONE** — часовой пояс, например `Europe/Moscow`.

---

## Структура проекта

```text
viraj_app/
├── bot/                         # Telegram‑бот (aiogram 3)
│   ├── handlers/               # Обработчики команд, меню, регистрации, уведомлений
│   ├── keyboards/              # Клавиатуры для бота
│   ├── middleware/             # Авторизация и контекст пользователя
│   └── utils/                  # Утилиты бота
├── api/                        # FastAPI приложение (эндпоинты для mini-app)
│   ├── routes/                 # Маршруты API
│   └── models/                 # Pydantic‑модели ответов
├── database/                   # Работа с БД
│   ├── models.py               # SQLAlchemy‑модели
│   └── migrations/             # Миграции Alembic
├── miniapp/                    # Telegram Mini App (в перспективе)
│   ├── index.html              # Стартовая страница
│   ├── js/app.js               # Клиентская логика
│   └── css/styles.css          # Стили
├── services/                   # Доменные сервисы
│   ├── notification_service.py # Логика планирования уведомлений
│   └── scheduler.py            # Планировщик (APScheduler)
├── utils/                      # Общие утилиты
│   ├── permissions.py          # Проверка ролей и прав
│   ├── export.py               # Экспорт регистраций в CSV/Excel
│   └── timezone.py             # Работа с часовыми поясами
├── config.py                   # Загрузка настроек из .env
├── requirements.txt            # Зависимости Python
├── run.sh                      # Скрипт запуска бота и API
└── README.md                   # Документация
```

---

## Роли и функциональность

### Пользователи (бот)

- Просмотр списка активных событий.
- Просмотр деталей события (описание, время с учётом таймзоны, фото).
- Регистрация на события по настраиваемой анкете.
- Просмотр своих регистраций и самостоятельная отмена участия.

### Администраторы

- Создание / редактирование / архивирование и полное удаление событий.
- Добавление фотографий и ограничений по количеству участников.
- Просмотр и экспорт регистраций (CSV, Excel с ссылками на Telegram пользователей).
- Ручная отмена регистраций с опциональным уведомлением пользователя.
- Настройка уведомлений:
  - шаблоны с «минуты/дни до события» или абсолютным временем;
  - включение/выключение кнопок подтверждения в уведомлениях;
  - выбор получателей уведомлений.
- Просмотр и управление пользователями, назначение помощников.

### Помощники

- Создание черновиков событий (с последующим утверждением админом).
- Редактирование событий, на которые есть права.
- Просмотр регистраций и отправка уведомлений по своим событиям.

---

## Система уведомлений

- Планировщик (`APScheduler`) проверяет очередь каждые **30 секунд**.
- Настройки уведомлений задаются на уровне события:
  - по шаблону (минуты/дни до события или фиксированная дата/время),
  - кастомное время в минутах до события.
- Для каждой регистрации создаются записи `ScheduledNotification` в UTC,  
  при срабатывании бот отправляет пользователю:
  - текст с названием и временем события,
  - кнопки: **подтвердить участие / отказаться / связаться со мной**.

---

## Git и развёртывание

Проект готов к размещению в Git:

- в репозитории хранятся **только исходники и миграции**;
- локальные файлы среды (`.env`, БД, кеши IDE, виртуальное окружение) исключены через `.gitignore`;
- зависимости зафиксированы в `requirements.txt`.

Базовые шаги:

```bash
git init
git add .
git commit -m "Initial import of Telegram event registration bot"
git remote add origin <URL_ВАШЕГО_РЕПОЗИТОРИЯ>
git push -u origin main
```

