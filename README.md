## Бот регистрации на события в Telegram

Система для регистрации на события и мастер‑классы через Telegram:

- **Пользователь** просматривает события и регистрируется **прямо в боте**.
- **Администратор** и **помощники** управляют событиями, регистрациями, уведомлениями и экспортом данных.
- Уведомления о событиях отправляются автоматически по расписанию с учётом **часового пояса (GMT+3 по умолчанию)**.

Бот разворачивается как Docker‑контейнер, есть `docker-compose` и GitHub Actions для сборки образа в GitHub Container Registry.

---

## Быстрый старт (локально, без Docker)

```bash
git clone <URL_ВАШЕГО_РЕПОЗИТОРИЯ>.git
cd bot/app

python3 -m venv venv
source venv/bin/activate  # Linux/macOS
# или
venv\Scripts\activate     # Windows

pip install -r ../requirements.txt
```

Создайте `.env` на основе `example.env`:

```bash
cp example.env .env
```

Заполните в `.env` хотя бы:

- `BOT_TOKEN` — токен бота из [`@BotFather`](https://t.me/BotFather)
- `ADMIN_USER_IDS` — Telegram ID админов через запятую (`123,456`)
- при необходимости `TIMEZONE`, `DATABASE_URL` и т.п.

База по умолчанию — SQLite файл `event_registration.db` в `app/`.

Запуск бота локально:

```bash
cd bot/app
python -m bot.main
```

Планировщик уведомлений (`APScheduler`) поднимается автоматически внутри бота.

---

## Запуск через Docker

В корне `bot/` уже есть `Dockerfile` и `compose.yml`.

### 1. Подготовка `.env`

В каталоге `bot/`:

```bash
cp app/example.env .env
nano .env  # или любой другой редактор
```

Заполните `BOT_TOKEN`, `ADMIN_USER_IDS` и другие нужные поля.

### 2. Сборка и запуск

```bash
cd bot
docker-compose up --build -d
```

Контейнер:

- запускает бота (`python -m bot.main`) из каталога `/app/app`,
- использует `.env`, смонтированный через `env_file` в `compose.yml`.

Порт `8000` в `compose.yml` и `Dockerfile` относится к FastAPI‑API и нужен только если вы планируете использовать HTTP‑интерфейс/mini‑app; для работы самого бота он не обязателен.

---

## Переменные окружения

Все настройки читаются из `.env` через `app/config.py` (`pydantic-settings`):

- **BOT_TOKEN** — токен Telegram‑бота.
- **WEBAPP_URL** — (опционально) базовый URL мини‑приложения.
- **DATABASE_URL** — строка подключения к БД  
  Примеры:
  - `sqlite:///./event_registration.db`
  - `postgresql+psycopg2://user:password@localhost:5432/viraj`
- **API_HOST** — хост FastAPI (по умолчанию `0.0.0.0`).
- **API_PORT** — порт FastAPI (по умолчанию `8000`).
- **ADMIN_USER_IDS** — список Telegram ID админов, строка вида:
  - `123456789,987654321`
  - либо JSON‑массив: `[123456789,987654321]`
- **TIMEZONE** — часовой пояс, например `Europe/Moscow`.

---

## Структура проекта (упрощённо)

```text
bot/
├── app/
│   ├── bot/                     # Telegram‑бот (aiogram 3)
│   │   ├── handlers/           # Обработчики команд, меню, регистраций, уведомлений
│   │   ├── keyboards/          # Клавиатуры для бота
│   │   ├── middleware/         # Авторизация и контекст пользователя
│   │   └── utils/              # Утилиты бота
│   ├── api/                    # FastAPI‑приложение (опционально)
│   ├── database/               # Модели и миграции БД
│   ├── services/               # Сервисы (уведомления, планировщик)
│   ├── utils/                  # Общие утилиты (таймзона, экспорт и т.д.)
│   ├── config.py               # Загрузка настроек из .env
│   ├── run.sh                  # Скрипт запуска бота+API (локально)
│   └── event_registration.db   # SQLite‑БД (при использовании по умолчанию)
├── Dockerfile                  # Образ бота
├── compose.yml                 # docker-compose сервис mclassbot
├── requirements.txt            # Зависимости Python
└── README.md                   # Эта документация
```

Более подробная структура и диаграмма описаны в `DOCS.md`.

---

## Роли и функциональность

### Пользователи (бот)

- Просмотр списка активных событий.
- Просмотр деталей события (описание, время с учётом таймзоны, фото).
- Регистрация на события по настраиваемой анкете.
- Просмотр своих регистраций и самостоятельная отмена участия.

### Администраторы

- Создание / редактирование / архивирование и полное удаление событий.
- Добавление фотографий и ограничений по количеству участников.
- Просмотр и экспорт регистраций (CSV, Excel с ссылками на Telegram пользователей).
- Ручная отмена регистраций с опциональным уведомлением пользователя.
- Настройка уведомлений:
  - шаблоны с «минуты/дни до события» или абсолютным временем;
  - включение/выключение кнопок подтверждения в уведомлениях;
  - выбор получателей уведомлений.
- Просмотр и управление пользователями, назначение помощников, смена ролей.

### Помощники

- Создание черновиков событий (с последующим утверждением админом).
- Редактирование событий, на которые есть права.
- Просмотр регистраций и отправка уведомлений по своим событиям.

---

## Система уведомлений

- Планировщик (`APScheduler`) проверяет очередь каждые **30 секунд**.
- Настройки уведомлений задаются на уровне события:
  - по шаблону (минуты/дни до события или фиксированная дата/время),
  - кастомное время в минутах до события.
- Для каждой регистрации создаются записи `ScheduledNotification` в UTC,  
  при срабатывании бот отправляет пользователю:
  - текст с названием и временем события,
  - кнопки: **подтвердить участие / отказаться** (и прочие, если настроены).

---

## CI/CD и контейнеры

- В `.github/workflows/docker-image.yml` настроен GitHub Actions:
  - при пуше в `master` (или ручном запуске) собирает Docker‑образ;
  - пушит его в GitHub Container Registry `ghcr.io/<owner>/<repo>`.
- `Dockerfile` собирает образ на базе `python:3.11-slim`, копирует `app/` и запускает `python -m bot.main`.
- `compose.yml` поднимает один сервис `mclassbot` и подключает `.env`.

Дальше образ можно использовать в любой вашей инфраструктуре (server/VPS/k8s и т.п.).
